# システムの設計
<!-- Fig 1 -->

時系列データの分析のための可視化を表示しつつ、情報を手に入れたい地理的範囲や指標の選択に応じた情報を文章としてユーザに提供するためにシステムを設計する。
この章では課題からシステムの要件を定め、どのようにシステムを設計したのかを説明する。

<!-- 課題かけ -->

<!-- ## データ分析の問題
- **P1 データの変化** SPIデータの中の一つの指標で一つの時系列データの変化を調べる時、他のデータの分布によってはそのデータの変化が大きいのか小さいのかが変わる。
しかし生データのままでは、データアイテム数が多く、他のデータの分布を調べることが困難であり、結果として一つの時系列データの変化を調べることが難しくなる。

- **P2 地理的範囲の情報** SPIデータのアイテムは世界の国それぞれに対応している。
一つの国についてのデータを分析したいというニーズは存在することは当然だが、さらにアジアやヨーロッパなどといった地理的範囲でデータを分析することにも興味がある。
しかし、SPIデータにはそのような地理的範囲ごとのデータの集約が存在しないため、ユーザーが自身で計算する必要がある。 -->

<!-- 要件 -->

<!-- Fig 4 -->

![Figure 4: This figure shows the application of the system to the Social Progress Index dataset. In (a), the user can select the country, geographical area, and SPI index user wants to focus on. In (b) and (c), time series data visualization and automatically generated sentences are displayed according to the selection made in (a). In (d) is a world map to show the location of the country and geographical area of interest. (e) shows the definition of the SPI index to be selected in (a). ](img/4_SPI_Time_Series.png)

## 要件
<!-- 以上の問題をもとに以下のように要件を定めた。 -->
実際にシステムを作る前に、以下のように要件を定めた。

- **R1 変化の特定** SPIデータの中の一つの指標で一つの時系列データの変化を調べる時、他のデータの分布によってはそのデータの変化が大きいのか小さいのかが変わる。
しかし生データのままでは、データアイテム数が多く、他のデータの分布を調べることが困難であり、結果として一つの時系列データの変化を調べることが難しくなる。
そこで10年の時系列データを他のデータの分布を考慮した上で、傾向の変化があった年を特定して、データのの概要としてユーザーに提供する必要がある。

- **R2 階層的な情報** SPIデータのアイテムは世界の国それぞれに対応している。
一つの国についてのデータを分析したいというニーズは存在することは当然だが、さらにアジアやヨーロッパなどといった地理的範囲でデータを分析することにも興味がある。
しかし、SPIデータにはそのような地理的範囲ごとのデータの集約が存在しないため、ユーザーが自身で計算する必要がでてしまう。
そこでシステムでは、階層的な情報をあらかじめ提供する必要がある。
SPIデータには地理的な階層の情報が含まれていないので、[国連](https://www.un.org/)が提供している、地理的な階層についてのデータ[@unsd2003united]を追加で扱う。

- **R3 地理情報の表示** データアイテムである国のデータを分析する時や、地理的範囲の国々のデータを分析する際に、その国が地理的にどこに存在するかや、地理的範囲にどのような国が存在するかなどをユーザーが知っている必要がある。
しかし、ユーザーがそのような前提知識を持っていることは珍しい。
そのため、選択する地理的範囲や国の位置を視覚的にユーザーに提供する必要がある。

- **R4 概要** アイテム数の多いデータに対し、時系列データの変化や地理情報、階層的な情報などを視覚的な表現だけでは伝えきれない情報がある。
そこでその表示しているデータの概要を、文章によってユーザーに提供する必要がある。

<!-- **R5 時系列データ** 興味のある時系列データを分析することや、興味のある変化をしているデータを発見することを容易にする。 -->


<!--                        可視化について                -->
## 設計

可視化と文章を通して、SPIデータの詳細な情報や概要を提供する。
着目したいアイテムとして、国、アジアやヨーロッパなどといった地理的範囲を考える。
注目したい国については、そのデータの傾向やその傾向の変化を解析してその情報を提供する。

**傾向の変化する点** 時系列データの傾向の変化がある時、その変化があった点を特定してデータの概要としてユーザーに提供する。
まず何かしらの変化があるのか、それとも特に傾向が変化するわけではなく単調な傾向があるのかを判定する。
まず時系列データ似たいして線形回帰を行い、一次の直線を求める。
その直線と元のデータに対して、全ての年でデータの差が閾値より小さい場合には傾向は変化していない判断する。
一方、どこかの年でデータの差が閾値以上であれば傾向の変化がある可能性があるみなす。
次にJunhuaたちと同様にWin法[@truong2020selective]を活用して、データの傾向が変化する点を探す。
時系列データを$(x_1,x_2,...,x_n)$として、$(x_{i},x_{i+1})$の線形回帰直線の傾き$m^{(1)}_i$ $(1\leq i\leq n-1)$と、$(x_{i},x_{i+1},x_{i+2})$の線形回帰直線の傾き$m^{(2)}_i$ $(1\leq i\leq n-2)$を求める。
次に$d^{(j)}_i=|m^{(j)}_{i+1}-m^{(j)}_{i}|$ $(j=1,2\ \ 1\leq i\leq n-1-j)$を求める。
$j=1,2$両方に対して、$d^{(j)}_i$がある閾値以上であるとき、$x_{i+1}$の点を時系列データの傾向が変化した点として判断する。
この計算は、直近の左右のデータの傾きの差が大きい点を、データの傾向の変化があった点としている。
$d^{(1)}_i$は短い時間間隔でのデータの変化を捉えることができ、$d^{(2)}_i$は少し長い時間間隔でのデータの変化を捉えることができる。

注目する国についての情報に加えて、ユーザーを次なる探索へと誘導するために、注目する国とデータの変化が類似している国をユーザーに提供する。

**類似している国** 注目する国に対して、データの変化が類似している国を求める。
まず、注目する国と他の国の時系列データで、相関係数が大きい国々の集合$C$を集める。
その集合$C$の中の国のデータ$c_i$と注目する国のデータでユークリッド距離$d_i$を計算する。
その距離$d_i$が、ある閾値未満であれば、国$c_i$を類似している国とする。
二つの時系列データの上昇や減少などの大まかな変化が一致していることを相関係数によって絞り、注目する国と値が近く似た変動をする国を抽出するするために、時系列データのユークリッド距離を用いてる。

以上の情報を実際の可視化や文章生成に織り交ぜる。

### 時系列の可視化

時系列データの詳細な情報をユーザーに伝えるために、折れ線を利用したシステムを作る(図4b)。
しかしアイテム数の多い場合では、多くのデータが重なって表示されるためにこの恩恵を受けることができない。
アイテム数の多い折れ線からでも詳細な情報を提供できるように、特定のデータに対する折れ線をハイライトしたり、表示するデータを絞ったりする。
注目したい国と類似している国に対するデータをハイライトする。
またデータの概要を提供するために、注目する国のデータの傾向が変化する点をドットを用いて表現しつつ(**R1,R4**)、色を他の表現と異なるマゼンタ色を使う。
類似している国のデータに関してダークカーキ色を使う。

傾向が変化する点を抽出した後、折れ線にその情報を表現する。
できるだけ簡単な表現にするため、ドットを用いる。
傾向の変化がその指標の中でいい変化であれば白を、悪い変化であれば黒をドットの色に使って表現する。
複数傾向の変化があった点が存在する場合、その変化の大きさをドットの大きさを使って表現する。

### 地域の可視化

選択された地域的範囲をユーザーが難なく理解できるように、世界地図を用いてその範囲を表示する(図4d)。
選択された地理的範囲に含まれていない国々と、データが存在しない国は灰色で表される。
注目する国については、折れ線と同様の色で表現する。
これらによって、ユーザーが注目する国と地理的範囲の国々とで地理的比較が可能になっている。(**R3**)


<!--                 文章生成について                       -->
### 文章生成

データの可視化だけでは伝えきれない情報や、可視化で示したい情報を含んだデータの概要を文章で伝える(図4c)。
文章はLatifたちやHosokawaたちと同様に、テンプレートベースで生成する。(**R4**)
<!-- 文章は大きく分けて三つの情報を含んでおり、地理的範囲について、注目する国について、注目する国と類似する国についての情報がある。 -->
以下では以下の情報をデータから抽出して文章にしていく。

- 選択した地理的範囲に含まれる国々が、世界からみて指標の値が低いか高いか。
例: アメリカには世界の国々の中で社会進歩指標が低い国から高い国まで幅広く存在する。
- 選択した地理的範囲の国々で、指標の値が高い、もしくは低い国が下の階層の地理的範囲で偏りがあるか(**R2**)。
例: アメリカの中では北アメリカに社会進歩指標が高い国が多い。
- 注目する国指標に対する値が、選択した地理的範囲の国々の中で低いか高いか。
例: コスタリカはアメリカの国々の中で社会進歩指標が高い。
- 注目する国データはどのような動向があったか。
例: コスタリカの社会進歩指標の値は、2011年から2020年にかけてほとんど横ばいである。
- 選択した地理的範囲の国々の中で、注目する国と似たデータの動向があった国について。
例: コスタリカと似た動向のある国は、チリとウルグアイである。

指標、注目する国、地理的範囲から以上のよう無観点でデータを分析して文章を生成した。


<!--                 インタラクションについて                             -->
### インタラクション

ユーザーがより可視化からデータに関する情報を手に入れやすいようにインタラクションを導入する。

**ズーム/フィルタリング** 折れ線の表示において、注目したい国や地理的範囲のデータの変動をより詳細に観察したいときのために、ボタンによって縦軸の範囲を調整できるようにしている。選択した地理的範囲がアジアや南アメリカなど世界全体ではないときは、その選択した地理的範囲のデータだけを表す縦軸にするか世界のデータの範囲を縦軸にするかを調整することができる。
選択した国のデータだけに興味があるときは、縦軸をデータの最小値~最大値に調整することができる。
選択した地理的範囲を見ることは、世界から比べて極端に値が小さい、または大きい国しかその地理的範囲に存在しないときに、その国々のデータを確認するのに役立つ。
一方世界のデータの範囲を縦軸にすることで、世界から比べて極端に値の低い、または高い国がその選択した地理的範囲に含まれていることなどを知ることができる。

表示範囲の調整を行うズームだけでなく、表示する折れ線をフィルタリングするインタラクションを追加している。
注目する国、注目する国と類似している国、その他の国のデータそれぞれで、表示するか非表示にするか選ぶことができるようにてしている。
類似している国が多いときにそれらを非表示にすることにより、注目する国と類似していない国を目立たせることができる。
一方、類似している国に注目したいときには、類似していない国を非表示にすることができる。

**クエリ** 時系列データを見るとき、何かしら特徴的な動きから探索したいかもしれない。
その時のために、ユーザーのフリーハンドや用意した折れ線の形を入力としてデータを探索できるようにした。
このクエリでは時系列データの形に着目する。
入力されたデータの平均値が各国のデータの平均値と一緒になるように、データを平行移動させる。
その後は類似した国を見つける時と同様に、相関係数とユークリッド距離が閾値以内であればその国を出力に入れる。
このようにしてフリーハンドや用意した折れ線の形から、似た形をしたデータを探索することができる。

**関連付け** 折れ線、地理表現、文章と三つの方法でデータの情報を提供しているが、同じデータに関するものは同じ色で表現すことでデータの理解を促進できる。
例えば注目する国がどのようなデータを持っているかということと、地理的にどのような場所にある国かということをわかりやすくするために、折れ線と地理表現ではともにマゼンタを使って表現している。
また文章の中でこの国のことを述べるときにも、国名の色にマゼンタ使用している。
類似する国についても同様にダークカーキ色が使用されている。

**キー選択** ユーザーが欲しい情報を得ることができるように、データを抽出するいくつかのキーを選択できるようにした。
注目する国、地理的範囲、SPIの指標をボタンを使用して簡単に選択できるようにした。
注目する国については、地理的な位置や折れ線から選択できるようにしている。
これによってある国から地理的に近い国や、データが近い国などといった視点でデータを探索できるようになっている。


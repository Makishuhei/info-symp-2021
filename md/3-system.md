# システムの設計

時系列データの分析のための可視化を表示しつつ、情報を手に入れたい地理的範囲や指標の選択に応じた情報を文章としてユーザに提供するためにシステムを設計した。
このときSPiデータを時系列データとして分析するときに、ユーザーは地理的な階層(東アジアの中の日本やヨーロッパの中のイギリスなど)の情報を含んでデータを分析したいと仮定している。
しかしSPIデータには地理的な階層の情報が含まれていないので、[国際連合](https://www.un.org/)が提供している、地理的な階層についてのデータ[@unsd2003united]を追加で扱う。

<!--                      要件                             -->

## 要件

実際にシステムを作る前に、以下のように要件を定めた。

- **R1 変化の特定** 指標の値が極端に低い国に注目するときに表示する地理的範囲が広い(表示する国数が多い)と、注目する国のデータが潰れて表示されてしまい、そのデータの分析は困難になる。
そこで10年の時系列データの中で傾向の変化があった年を特定して、データのの概要としてユーザーに提供する必要がある。

- **R2 階層的な情報** 生データをそのまま分析するとき、個々の国についての情報を分析することはできないが、その階層的な見方はなかなか難しい。
そのため、階層的な情報を提供する必要がある。

- **R3 地理的範囲の表示** 地理的階層の情報を伝える際にどの国がその範囲に含まれているかをユーザーが知っている必要がある。
しかし、ある範囲に含まれる国を全てユーザーが知っていることはほとんどない。
そのため、選択する地理的範囲を視覚的にユーザーに提供する必要がある。

- **R4 概要** 複数のデータに対し、時系列データの変化や地理情報、階層的な情報などを視覚的な表現によって理解することは困難である。
そこでその表示しているデータの概要を、文章によってユーザーに提供する必要がある。

<!-- **R5 時系列データ** 興味のある時系列データを分析することや、興味のある変化をしているデータを発見することを容易にする。 -->


<!--                        可視化について                -->
## データの可視化

### 時系列の可視化

時系列データの可視化は折れ線やヒートマップを使って行うのが一般的である。
本論文では折れ線を用いてSPIデータの時間的変化を表現する。
しかし注目する地域的範囲が広いときに、ほとんどの折れ線では時間的な変動を認識することができない。
注目する国の概要やその国データと類似した国データをハイライトする。
注目する国に関してはデータの傾向が変化する点をドットを用いて表現しつつ(**R1,R4**)、色を他の表現と異なるマゼンタ色を使う。
注目する国と類似する国のデータに関してダークカーキ色を使う。

**傾向の変化する点** 時系列データの傾向の変化が会った時、その変化があった点を特定してデータの概要としてユーザーに提供したい。

まず何かしらの変化があるのか、それとも単調な動きをしているのかを判定する。
時系列データを線形回帰し一次の直線を求める。
その直線と元のデータに対し全ての年でデータの差が閾値より小さい場合には、傾向は変化していないとして判定する。
一方どこかの年でデータの差が閾値以上であれば傾向の変化があったろ判定する。

データの傾向が変化する点の求める方法は、Junhuaたちと同様にWin法[@truong2020selective]を適用する。
時系列データを$(x_1,x_2,...,x_n)$として初めに、$1\leq i\leq n-1$に対して$(x_{i},x_{i+1})$の線形回帰直線の傾き$m^{(1)}_i$を求め、$1\leq i\leq n-2$に対して$(x_{i},x_{i+1},x_{i+2})$の線形回帰直線の傾き$m^{(2)}_i$を求める。
次に$j=1,2$、$1\leq i\leq n-1-j$に対して$d^{(j)}_i=|m^{(j)}_{i+1}-m^{(j)}_{i}|$を求める。
そして$j=1,2$両方ともに対して、$d^{(j)}_i$が注目する指標に対するSPIデータの平均値を元にした閾値以上であるとき、$x_{i+1}$の点をデータの傾向が変化した点として捉える。
これは、ある点をを中心にして左右の直近のデータの傾きの差が大きい点を傾向の変化があった点としている。
$d^{(1)}_i$は短い時間間隔でのデータの変化を捉えることができ、$d^{(2)}_i$は少し長い時間間隔でのデータの変化を捉えることができる。

傾向が変化する点を抽出した後、折れ線にその情報を表現する。
できるだけ簡単な表現にするため、ドットを用いる。
傾向の変化がその指標の中でいい変化であれば白を、悪い変化であれば黒をドットの色に使って表現する。
複数傾向の変化があった点が存在する場合、その変化の大きさをドットの大きさを使って表現する。

**類似する国** 類似する国を定義する。
初めに注目する国と他の国の時系列データで相関係数が大きい国を集める。
その集合の中で、注目する国と他の国データでユークリッド距離を計算する。
その距離が注目する指標に対するSPIデータの平均値を元にした閾値未満であれば、類似する国とする。
相関係数は、二つの時系列データの上昇や現象などの大まかな変動が一致していることを条件にするために使用している。
その後時系列データを$n$次元ベクトルと考え、ユークリッド距離が近いデータを選択することで、注目する国と値が近く似た変動をする国を抽出することができる。


### 地域の可視化

選択された地域的範囲をユーザーが難なく理解できるように、世界地図を用いてその範囲を表示する(**R3**)。
選択された地理的範囲に含まれていない国々と、データが存在しない国は灰色で表される。
注目する国については、折れ線と同様の色で表現する。
これらによって、ユーザーが注目する国と地理的範囲の国々とで地理的比較が可能になっている。


<!--                 文章生成について                       -->
## 文章生成

データの可視化だけでは伝えきれない情報や、可視化で示したい情報を含んだデータの概要を文章で伝える(**R4**)。
文章はLatifたちやHosokawaたちと同様に、テンプレートベースで生成する。
<!-- 文章は大きく分けて三つの情報を含んでおり、地理的範囲について、注目する国について、注目する国と類似する国についての情報がある。 -->
以下では以下の情報をデータから抽出して文章にしていく。

- 選択した地理的範囲に含まれる国々が、世界からみて指標の値が低いか高いか。
例: アメリカには世界の国々の中で社会進歩指標が低い国から高い国まで幅広く存在する。
- 選択した地理的範囲の国々で、指標の値が高い、もしくは低い国が下の階層の地理的範囲で偏りがあるか(**R2**)。
例: アメリカの中では北アメリカに社会進歩指標が高い国が多い。
- 注目する国指標に対する値が、選択した地理的範囲の国々の中で低いか高いか。
例: コスタリカはアメリカの国々の中で社会進歩指標が高い。
- 注目する国データはどのような動向があったか。
例: コスタリカの社会進歩指標の値は、2011年から2020年にかけてほとんど横ばいである。
- 選択した地理的範囲の国々の中で、注目する国と似たデータの動向があった国について。
例: コスタリカと似た動向のある国は、チリとウルグアイである。

指標、注目する国、地理的範囲から以上のよう無観点でデータを分析して文章を生成した。


<!--                 インタラクションについて                             -->
## インタラクション

ユーザーがより可視化からデータに関する情報を手に入れやすいようにインタラクションを導入する。

**ズーム/フィルタリング** 折れ線の表示において、注目したい国や地理的範囲のデータの変動をより詳細に観察したいときのために、ボタンによって縦軸の範囲を調整できるようにしている。選択した地理的範囲がアジアや南アメリカなど世界全体ではないときは、その選択した地理的範囲のデータだけを表す縦軸にするか世界のデータの範囲を縦軸にするかを調整することができる。
選択した国のデータだけに興味があるときは、縦軸をデータの最小値~最大値に調整することができる。
選択した地理的範囲を見ることは、世界から比べて極端に値が小さい、または大きい国しかその地理的範囲に存在しないときに、その国々のデータを確認するのに役立つ。
一方世界のデータの範囲を縦軸にすることで、世界から比べて極端に値の低い、または高い国がその選択した地理的範囲に含まれていることなどを知ることができる。

表示範囲の調整を行うズームだけでなく、表示する折れ線をフィルタリングするインタラクションを追加している。
注目する国、注目する国と類似している国、その他の国のデータそれぞれで、表示するか非表示にするか選ぶことができるようにてしている。
類似している国が多いときにそれらを非表示にすることにより、注目する国と類似していない国を目立たせることができる。
一方、類似している国に注目したいときには、類似していない国を非表示にすることができる。

**クエリ** 時系列データを見るとき、何かしら特徴的な動きから探索したいかもしれない。
その時のために、ユーザーのフリーハンドや用意した折れ線の形を入力としてデータを探索できるようにした。
このクエリでは時系列データの形に着目する。
入力されたデータの平均値が各国のデータの平均値と一緒になるように、データを平行移動させる。
その後は類似した国を見つける時と同様に、相関係数とユークリッド距離が閾値以内であればその国を出力に入れる。
このようにしてフリーハンドや用意した折れ線の形から、似た形をしたデータを探索することができる。

**関連付け** 折れ線、地理表現、文章と三つの方法でデータの情報を提供しているが、同じデータに関するものは同じ色で表現すことでデータの理解を促進できる。
例えば注目する国がどのようなデータを持っているかということと、地理的にどのような場所にある国かということをわかりやすくするために、折れ線と地理表現ではともにマゼンタを使って表現している。
また文章の中でこの国のことを述べるときにも、国名の色にマゼンタ使用している。
類似する国についても同様にダークカーキ色が使用されている。

**キー選択** ユーザーが欲しい情報を得ることができるように、データを抽出するいくつかのキーを選択できるようにした。
注目する国、地理的範囲、SPIの指標をボタンを使用して簡単に選択できるようにした。
注目する国については、地理的な位置や折れ線から選択できるようにしている。
これによってある国から地理的に近い国や、データが近い国などといった視点でデータを探索できるようになっている。

**図**
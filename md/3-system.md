# システムの設計

<!-- 本研究では、アイテム数の多い時系列データの特徴を可視化と文章にをユーザーに提示し、その後データの探索をサポートするシステムを設計する。
文章生成において、Latifらを参考にしてテンプレートベースで文章を生成する。
その時に文章の量が多くならないようにHosokawaらのようにデータの構造に注目して文章を生成する。
本研究では、SPIデータの国の地理的な階層性だけに注目して文章を生成しており、指標の階層性に注目した時系列データに対する文章生成は今後の研究課題とする。
また、Luらが行った手法を参考に時系列データを解析して、時系列データの特徴を説明する。
生成される文章の量を短くするために、解析する時系列データをユーザーの探索に合わせて選択する。 -->

<!-- Fig 4 -->

説明的可視化を通して、データ項目数の多い時系列データの探索をサポートするシステムを設計する。
この章では課題からシステムの要件を定め、SPIデータを例にどのようにシステムを設計したのかを説明する。

![Figure 4: This figure shows the application of the system to the Social Progress Index dataset. In (a), the user can select the country, geographical area, and SPI index user wants to focus on. In (b) and (c), time series data visualization and automatically generated sentences are displayed according to the selection made in (a). In (d) is a world map to show the location of the country and geographical area of interest. (e) shows the definition of the SPI index to be selected in (a). ](img/4_SPI_Time_Series.png)

<!-- 要件 -->

## 要件
<!-- 以上の問題をもとに以下のように要件を定めた。 -->
データ項目数の多い時系列データに対する本研究におけるシステムの要件を定める。

**R1 時系列データの変化の特徴**: 
同じ属性に対して時系列データが複数存在するとき、時系列データの値の変化は、他のデータの分布によって捉え方が変わる。
例えば同じ1から2への変化でも、0から100の値を取る属性においては小さな変化、もしくはほとんど変化していないと捉えることができるが、0から10の値を取る属性においては大きな変化として捉えることができる。
そこでデータを自動で解析して時系列データの変化に対する特徴を提供する必要がある。

**R2 データの関係性から見た概要**:
データのなかには、データ項目間に階層性や包含など何かしらの関係が存在したり、データ項目に位置情報が関連づけられたりすることがある。
そのようなときに、データの特徴を理解させるために、関係性やデータ項目に関連づけられた情報から見たデータの特徴も提供する必要がある。

**R3 データ項目を絞ったデータの探索**: 
データ全て解析してデータの特徴を全て可視化と文章で提示したとしても、ユーザーがその特徴を全て認識することができない。
ユーザーが注目したいデータ項目だけに絞ったデータの探索をサポートする必要がある。

<!--                        可視化について                -->
## 設計

SPIデータを扱った例で、システムの設計を説明していく。

### SPIデータ

SPIデータがどのようなデータか、どのような構造があるかを述べる。
SPIデータは、Social Progress Indexという指標で世界各国を評価したもので、指標は70個ほど存在する。
SPIの指標は、経済指標とは独立した実質的な生活の質の総合的な指標で世界各国を評価したものであり、社会の成功度合いを測るためにGDPなどの経済指標を補完するものとして設計されている。
SPIデータでは、世界の各国をデータ項目としている。
国はアジアやアフリカなどと州単位でまとめたり、東アジア、東南アジアなどといった州の中でも細分化された集合でまとめたりすることができる。
つまりSPIデータにおいて、地理的範囲による階層構造の関係が存在すると考えることができる。
しかし、SPIデータには地理的な階層の情報が含まれていないので、[国連](https://www.un.org/)が提供している、地理的範囲の階層についてのデータ[@unsd2003united]を追加で扱う。

### 可視化と文章生成

SPIデータをもとに、三つの要件に対してどのようにシステムを設計したか述べる。

**データの選択**:
探索する時に、ユーザーが注目したいデータ項目を絞れるようにする(**R3**)。
SPIデータでは、注目する国と指標に加え、先に述べた地理的範囲によるデータ項目の選択をできるようにする(図4a)。
また、後に述べるインタラクションを導入することでこのデータ項目の選択を、より探索のニーズに沿って実現できるようにした。

**傾向の変化する点**: 
時系列データの変化の特徴として、時系列データの傾向を調査する(**R1**)。
そして時系列データの変化の傾向についてと、傾向の変化があるときには変化があった点をユーザーに提供する。
まず時系列データ似たいして線形回帰を行い、一次の直線を求める。
その直線と元のデータに対して、全ての年でデータの差が閾値より小さい場合には単調な変化をしていると捉える。
この閾値は指標に対する全てのデータ項目の値に依存しているため、この閾値を用いることでデータの変化が大きいか小さいかを判断することができる。
変化が単調な場合は、線形回帰直線の傾きから、「10年間大きく上昇している。」や「10年間ほとんど横ばいである。」などといった変化の概要を捉える。
一方どこかの年でデータの差が閾値以上であれば、傾向の変化がある可能性があるとみなす。
次にJunhuaらと同様にWin法[@truong2020selective]を活用して、データの傾向が変化する点を調査する。
時系列データを$(x_1,x_2,...,x_n)$として、$(x_{i},x_{i+1})$の線形回帰直線の傾き$m^{(1)}_i$ $(1\leq i\leq n-1)$と、$(x_{i},x_{i+1},x_{i+2})$の線形回帰直線の傾き$m^{(2)}_i$ $(1\leq i\leq n-2)$を求める。
次に$d^{(j)}_i=|m^{(j)}_{i+1}-m^{(j)}_{i}|$ $(j=1,2\ \ 1\leq i\leq n-1-j)$を求める。
$j=1,2$両方に対して、$d^{(j)}_i$が閾値以上であるとき、$x_{i+1}$の点を時系列データの傾向が変化した点として判断する。
この閾値も、指標に対する全てのデータ項目の値に依存している。
この計算は、直近の左右のデータの傾きの差が大きい点をデータの傾向の変化があった点と見なしている。
このとき、$d^{(1)}_i$は短い時間間隔でのデータの変化を、$d^{(2)}_i$は少し長い時間間隔でのデータの変化を捉えることができる。

**類似しているデータ項目**:
注目するデータ項目に対して、類似した変化と値をとっているデータ項目を探る(**R1**)。
SPIデータでは、注目する国のデータに対してデータの変化が類似している国を求める。
注目する国に対して、時系列データの相関係数が大きい国々の集合$C$を集める。
$C$の中の国のデータ$c_i$と注目する国のデータでユークリッド距離$d_i$を計算する。
その距離$d_i$がある閾値未満であれば、国$c_i$を類似している国とする。
この閾値も先ほどと同様に、指標に対する全てのデータ項目の値に依存している。
二つの時系列データの上昇や減少などの大まかな変化が一致していることを相関係数によって絞り、注目する国と値が近く似た変動をする国を抽出するするために、時系列データのユークリッド距離を用いてる。

**データの概要の可視化**:
時系列データの詳細な特徴と、属性に対する全てのデータ項目のデータの分布をユーザーに伝えるために、折れ線を利用しる(図4b)。
データ項目数の多い場合では、多くのデータが重なって表示されるためにこの恩恵を受けることができない。
データ項目数の多い折れ線からでも詳細なデータを提供できるように、特定のデータに対する折れ線をハイライトしたり、表示するデータを絞ったりする(**R1,R3**)。
注目したい国と類似している国に対するデータをハイライトする。
またデータの概要を提供するために、注目するデータ項目の時系列データの傾向が変化する点をドットを用いて表現しつつ、色を他の表現と異なるマゼンタ色を使う。
類似しているデータ項目に関してはダークカーキ色を使う。
ドットの色は傾向の変化がその指標の中でいい変化であれば白を、悪い変化であれば黒をドットの色に使って表現する。
複数傾向の変化があった点が存在する場合、その変化の大きさをドットの大きさを使って表現する。

**地理的範囲の表示**:
データ項目に関連づけられている位置情報をユーザーに提供する(**R2**)。
SPIデータでは、データ項目が世界各国に対応しているため、ユーザーが注目するデータ項目や地理的範囲を世界地図に表示する(図4d)。
注目する国と、類似している国については、それぞれ折れ線と同様の色で表現する。
選択された地理的範囲に含まれていない国々と、データが存在しない国は灰色で表されている。
これによって、ユーザーが注目する国と地理的範囲の国々とで地理的な関係を探索することができる(**R3**)。

<!--                 文章生成について                       -->
**文章生成**:
可視化で伝えたいデータ特徴や、探索の手がかりとなるデータの特徴などを文章で伝える(図4c)。
文章はLatifらやHosokawaらと同様に、テンプレートベースで生成する。
文章は以下のデータ特徴について、データを解析して生成した。

- 選択した地理的範囲に含まれるデータ項目群が、世界から見て指標の値が低いか高いか(**R2**)。
例: アメリカには世界の国々の中で社会進歩指標が低い国から高い国まで幅広く存在する。

- 選択した地理的範囲の子の階層の地理的範囲で、指標の値が高い、もしくは低いデータ項目が多いなどのが偏りがあるか(**R2**)。
例: アメリカの中では北アメリカに社会進歩指標が高い国が多い。

- 注目するデータ項目の指標に対する値が、選択した地理的範囲のデータ項目群の中で低いか高いか(**R1,R2**)。
例: コスタリカはアメリカの国々の中で社会進歩指標が高い。

- 注目するデータ項目のデータはどのような動向があったか(**R1**)。
例: コスタリカの社会進歩指標の値は、2011年から2020年にかけてほとんど横ばいである。

- 選択した地理的範囲のデータ項目群の中で、注目するデータ項目と類似しているデータ項目について(**R1**)。
例: コスタリカと似た動向のある国は、チリとウルグアイである。

<!--                 インタラクションについて                             -->
### インタラクション

ユーザーが可視化や文章からデータを探索できるように、インタラクションを導入する。

**ズーム**: 
折れ線の表示において、地理的範囲のデータ項目群や注目したいデータ項目のデータの変動をより詳細に観察できるように、ボタンによって縦軸の範囲を調整できるようにしている。
世界のデータの範囲を縦軸にすることで、地理的範囲に含まれるデータ項目群のデータが、世界と比べてどのような値をとっているか、その分布を確認することができる。
注目するデータ項目のデータだけに興味があるときは、そのデータの詳細が確認できる大きさにグラフの縦軸を調整する。
選択した地理的範囲のデータ項目のデータの範囲を見ることは、データの分布が地理的範囲によって偏りが大きい時に役立つ。

**フィルタリング**:
折れ線の表示において、表示する折れ線をフィルタリングする機能を実装した。
注目するデータ項目、類似しているデータ項目、その他のデータ項目のデータそれぞれで表示するか非表示にするか選ぶことができる。
類似しているデータ項目が多いときにそれらを非表示にすることにより、注目するデータ項目と類似していない国を調べることができる。
一方、類似しているデータ項目に注目したいときには、類似していないデータ項目を非表示にすることができる。

**クエリ**: 
時系列データを見るとき、特徴的な変化から探索したい可能性がある。
そこで、ユーザーのフリーハンドや用意した折れ線の形を入力としてデータを探索できるようにした。

**関連付け**: 
折れ線、世界地図、文章と三つの方法でデータの特徴を提供しているが、同じデータ項目に関する折れ線や地図、文字は同じ色で表現している。
これにより、同じデータ項目に関するデータの特徴の理解を促進できる。

**データ項目の選択**: 
ユーザーが欲しいデータの特徴を入手できるように、いくつかの視点でデータ項目を選択できる機能を実装した。
折れ線の表示においては折れ線を選択することで、世界地図からは国を選択することで、注目するデータ項目を変更できるようにしている。
これにより、データの変動の仕方や地理的な位置から、興味のあるデータ項目の特徴を得ることができる。